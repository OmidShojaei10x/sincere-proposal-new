// Main JavaScript

// Configuration
const CONFIG = {
    apiEndpoint: null, // For future backend integration
    localStorageKey: 'sincere_proposal_data',
    autoSaveInterval: 30000, // 30 seconds
};

// Data Management
class DataManager {
    constructor() {
        this.data = this.loadData();
    }

    loadData() {
        const saved = localStorage.getItem(CONFIG.localStorageKey);
        return saved ? JSON.parse(saved) : this.getDefaultData();
    }

    getDefaultData() {
        return {
            duration: '۴ ماه',
            totalValue: '۱,۸۰۰,۰۰۰,۰۰۰',
            startDate: 'اواسط دی ۱۴۰۴',
            presentationDate: 'آذر ۱۴۰۴',
            // Add more editable fields
        };
    }

    saveData() {
        localStorage.setItem(CONFIG.localStorageKey, JSON.stringify(this.data));
    }

    updateField(field, value) {
        this.data[field] = value;
        this.saveData();
    }

    getData(field) {
        return this.data[field];
    }
}

const dataManager = new DataManager();

// Editable Text Elements
function initEditableElements() {
    document.querySelectorAll('.editable-text').forEach(el => {
        const field = el.dataset.field;
        
        // Set initial value
        if (dataManager.getData(field)) {
            el.textContent = dataManager.getData(field);
        }

        // Make editable on click
        el.addEventListener('click', () => {
            if (el.getAttribute('contenteditable') !== 'true') {
                el.setAttribute('contenteditable', 'true');
                el.focus();
                
                // Select all text
                const range = document.createRange();
                range.selectNodeContents(el);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            }
        });

        // Save on blur
        el.addEventListener('blur', () => {
            el.setAttribute('contenteditable', 'false');
            dataManager.updateField(field, el.textContent.trim());
        });

        // Save on Enter
        el.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                el.blur();
            }
        });
    });
}

// Logo Upload
function initLogoUpload() {
    document.querySelectorAll('.editable-logo').forEach(logo => {
        logo.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,.svg';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        logo.src = event.target.result;
                        
                        // Save to localStorage
                        const logoType = logo.dataset.logoType;
                        localStorage.setItem(`logo_${logoType}`, event.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            input.click();
        });

        // Load saved logo
        const logoType = logo.dataset.logoType;
        const savedLogo = localStorage.getItem(`logo_${logoType}`);
        if (savedLogo) {
            logo.src = savedLogo;
        }
    });
}

// Mobile Menu
document.getElementById('mobile-menu-btn')?.addEventListener('click', () => {
    const menu = document.getElementById('mobile-menu');
    menu.classList.toggle('hidden');
});

// Reading Progress
function updateReadingProgress() {
    const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
    const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    const scrolled = (winScroll / height) * 100;
    document.getElementById('reading-progress').style.width = scrolled + '%';
}

window.addEventListener('scroll', updateReadingProgress);

// Smooth Scroll
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
            const offsetTop = target.offsetTop - 100;
            window.scrollTo({
                top: offsetTop,
                behavior: 'smooth'
            });

            // Close mobile menu if open
            document.getElementById('mobile-menu')?.classList.add('hidden');
        }
    });
});

// PDF Export
async function exportToPDF() {
    // Show loading
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '⏳ در حال تولید...';
    btn.disabled = true;

    try {
        // Use browser's print dialog
        window.print();
    } catch (error) {
        alert('خطا در تولید PDF');
        console.error(error);
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// Initialize on load
document.addEventListener('DOMContentLoaded', () => {
    initEditableElements();
    initLogoUpload();
    loadSections();
});

// Auto-save
setInterval(() => {
    dataManager.saveData();
}, CONFIG.autoSaveInterval);

// Load Sections Dynamically
async function loadSections() {
    const sectionsContainer = document.getElementById('content-sections');
    
    const sections = [
        'executive-summary',
        'current-analysis',
        'goals',
        'strategy',
        'services/social-media',
        'services/website',
        'services/photography',
        'services/events',
        'timeline',
        'budget',
        'kpis',
        'checklist',
    ];

    for (const section of sections) {
        try {
            const response = await fetch(`sections/${section}.html`);
            const html = await response.text();
            
            const wrapper = document.createElement('div');
            wrapper.innerHTML = html;
            sectionsContainer.appendChild(wrapper);
        } catch (error) {
            console.error(`Error loading section ${section}:`, error);
        }
    }

    // Re-initialize editable elements after loading
    initEditableElements();
}